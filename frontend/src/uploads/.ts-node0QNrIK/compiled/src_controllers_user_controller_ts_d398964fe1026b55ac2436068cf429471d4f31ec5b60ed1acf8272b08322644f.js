"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.createProfileHandler = createProfileHandler;
exports.updateProfileHandler = updateProfileHandler;
exports.getAllUserHandler = getAllUserHandler;
exports.deleteProfileHandler = deleteProfileHandler;
exports.getCurrentUserHandler = getCurrentUserHandler;
exports.getFriendsOfUserHandler = getFriendsOfUserHandler;
exports.getUserByIdHandler = getUserByIdHandler;
const database_1 = __importDefault(require("../db/database"));
const utils_1 = require("../utils/utils");
async function createProfileHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    const body = req.body;
    const profile = { userId: body.id, fname: body.fname, lname: body.lname, username: body.username, bio: body?.bio ?? 'Ready to play. Ready to win.', avatar: body.avatar };
    try {
        console.log("is created ssss111");
        await database_1.default.profile.create({ data: profile });
        console.log("is created ssss222");
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function updateProfileHandler(req, res) {
    const respond = { success: true, message: 'user updated success' };
    try {
        const body = await (0, utils_1.convertMultipartToJson)(req);
        console.log('bodyyyyyy', body);
        const headers = req.headers;
        const userId = Number(headers['x-user-id']);
        await database_1.default.profile.update({ where: { userId }, data: body });
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function getAllUserHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    try {
        const headers = req.headers;
        const userId = Number(headers['x-user-id']);
        const friendships = await database_1.default.friendship.findMany();
        const friendIds = [...new Set(friendships.flatMap((f) => { return [f.userId, f.friendId]; }))];
        if (!friendIds.includes(userId))
            friendIds.push(userId);
        const profile = await database_1.default.profile.findMany({ where: { userId: { notIn: friendIds } } });
        respond.data = profile;
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function deleteProfileHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    try {
        // const headers = req.headers as any;
        // const userId = Number(headers['x-user-id'])
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function getCurrentUserHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    try {
        const headers = req.headers;
        const userId = Number(headers['x-user-id']);
        const profile = await database_1.default.profile.findUnique({ where: { userId: userId } });
        respond.data = profile;
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function getFriendsOfUserHandler(req, res) {
    const params = req.params;
    const userId = Number(params.userId);
    const respond = { success: true, message: 'get all users ' };
    try {
        const friendships = await database_1.default.friendship.findMany({
            where: {
                status: 'accepted',
                OR: [
                    { userId: userId },
                    { friendId: userId }
                ]
            }
        });
        const friendIds = friendships.map((f) => { return (userId != f.userId) ? f.userId : f.friendId; });
        const profiles = await database_1.default.profile.findMany({ where: { id: { in: friendIds } } });
        respond.data = profiles;
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function getUserByIdHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    const { id } = req.params;
    try {
        const profile = await database_1.default.profile.findUnique({ where: { userId: Number(id) } });
        respond.data = profile;
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3VzZXIvc3JjL2NvbnRyb2xsZXJzL3VzZXIuY29udHJvbGxlci50cyIsInNvdXJjZXMiOlsiL3VzZXIvc3JjL2NvbnRyb2xsZXJzL3VzZXIuY29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQU1BLG9EQXNCQztBQUlELG9EQTBCQztBQUdELDhDQTZCQztBQUdELG9EQXFCQztBQUVELHNEQXVCQztBQUdELDBEQXFDQztBQUtELGdEQXFCQztBQTVNRCw4REFBb0M7QUFDcEMsMENBQXdEO0FBSWpELEtBQUssVUFBVSxvQkFBb0IsQ0FBQyxHQUFrQixFQUFHLEdBQWdCO0lBRTVFLE1BQU0sT0FBTyxHQUF3QixFQUFDLE9BQU8sRUFBRyxJQUFJLEVBQUksT0FBTyxFQUFHLHNCQUFzQixFQUFDLENBQUE7SUFDekYsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLElBQVcsQ0FBQztJQUM3QixNQUFNLE9BQU8sR0FBRyxFQUFDLE1BQU0sRUFBRyxJQUFJLENBQUMsRUFBRSxFQUFHLEtBQUssRUFBRyxJQUFJLENBQUMsS0FBSyxFQUFHLEtBQUssRUFBRyxJQUFJLENBQUMsS0FBSyxFQUFJLFFBQVEsRUFBRyxJQUFJLENBQUMsUUFBUSxFQUFJLEdBQUcsRUFBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLDhCQUE4QixFQUFJLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUE7SUFFckwsSUFDQSxDQUFDO1FBQ0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO1FBQ2pDLE1BQU0sa0JBQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUMsSUFBSSxFQUFHLE9BQU8sRUFBQyxDQUFDLENBQUE7UUFDN0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFBO0lBQ25DLENBQUM7SUFDRCxPQUFPLEtBQUssRUFDWixDQUFDO1FBQ0MsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxLQUFLLFlBQVksS0FBSyxFQUN4QixDQUFDO1lBQ0MsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1lBQ2hDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDdEMsQ0FBQztJQUNMLENBQUM7SUFDRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7QUFDNUIsQ0FBQztBQUlNLEtBQUssVUFBVSxvQkFBb0IsQ0FBQyxHQUFrQixFQUFHLEdBQWdCO0lBRzVFLE1BQU0sT0FBTyxHQUF3QixFQUFDLE9BQU8sRUFBRyxJQUFJLEVBQUksT0FBTyxFQUFHLHNCQUFzQixFQUFDLENBQUE7SUFFekYsSUFDQSxDQUFDO1FBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxJQUFBLDhCQUFzQixFQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQy9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFLLElBQUksQ0FBQyxDQUFBO1FBQ2pDLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxPQUFjLENBQUM7UUFDbkMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFBO1FBRTNDLE1BQU0sa0JBQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLEVBQUMsS0FBSyxFQUFHLEVBQUMsTUFBTSxFQUFDLEVBQUcsSUFBSSxFQUFHLElBQUksRUFBRSxDQUFDLENBQUE7SUFDOUQsQ0FBQztJQUNELE9BQU8sS0FBSyxFQUNaLENBQUM7UUFDRyxPQUFPLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUN4QixJQUFJLEtBQUssWUFBWSxLQUFLLEVBQ3hCLENBQUM7WUFDQyxPQUFPLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7WUFDaEMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUN0QyxDQUFDO0lBQ1AsQ0FBQztJQUVELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtBQUM1QixDQUFDO0FBR00sS0FBSyxVQUFVLGlCQUFpQixDQUFDLEdBQWtCLEVBQUcsR0FBZ0I7SUFFekUsTUFBTSxPQUFPLEdBQWdDLEVBQUMsT0FBTyxFQUFHLElBQUksRUFBSSxPQUFPLEVBQUcsc0JBQXNCLEVBQUMsQ0FBQTtJQUVqRyxJQUNBLENBQUM7UUFDRyxNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBYyxDQUFDO1FBQ25DLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQTtRQUczQyxNQUFNLFdBQVcsR0FBRyxNQUFNLGtCQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3ZELE1BQU0sU0FBUyxHQUFJLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBSyxFQUFFLEVBQUUsR0FBRSxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUEsQ0FBQSxDQUFDLENBQUMsQ0FBQyxDQUFRLENBQUM7UUFDeEcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDO1lBQzNCLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFM0IsTUFBTSxPQUFPLEdBQUcsTUFBTSxrQkFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBQyxLQUFLLEVBQUcsRUFBQyxNQUFNLEVBQUcsRUFBQyxLQUFLLEVBQUUsU0FBUyxFQUFDLEVBQUMsRUFBQyxDQUFDLENBQUM7UUFDdkYsT0FBTyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUM7SUFDM0IsQ0FBQztJQUNELE9BQU8sS0FBSyxFQUNaLENBQUM7UUFDRyxPQUFPLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUN4QixJQUFJLEtBQUssWUFBWSxLQUFLLEVBQ3hCLENBQUM7WUFDQyxPQUFPLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUM7WUFDaEMsT0FBTyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtRQUN0QyxDQUFDO0lBQ1AsQ0FBQztJQUVELE9BQU8sR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQTtBQUM1QixDQUFDO0FBR00sS0FBSyxVQUFVLG9CQUFvQixDQUFDLEdBQWtCLEVBQUcsR0FBZ0I7SUFFNUUsTUFBTSxPQUFPLEdBQXVCLEVBQUMsT0FBTyxFQUFHLElBQUksRUFBSSxPQUFPLEVBQUcsc0JBQXNCLEVBQUMsQ0FBQTtJQUV4RixJQUNBLENBQUM7UUFDRCxzQ0FBc0M7UUFDdEMsOENBQThDO0lBRTlDLENBQUM7SUFDRCxPQUFPLEtBQUssRUFDWixDQUFDO1FBQ0csT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxLQUFLLFlBQVksS0FBSyxFQUN4QixDQUFDO1lBQ0MsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1lBQ2hDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDdEMsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7QUFDNUIsQ0FBQztBQUVNLEtBQUssVUFBVSxxQkFBcUIsQ0FBQyxHQUFrQixFQUFHLEdBQWdCO0lBRzdFLE1BQU0sT0FBTyxHQUFxQyxFQUFDLE9BQU8sRUFBRyxJQUFJLEVBQUksT0FBTyxFQUFHLHNCQUFzQixFQUFDLENBQUE7SUFFdEcsSUFDQSxDQUFDO1FBQ0csTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLE9BQWMsQ0FBQztRQUNuQyxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFXLENBQUM7UUFDdEQsTUFBTSxPQUFPLEdBQUcsTUFBTSxrQkFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFVLENBQUMsRUFBQyxLQUFLLEVBQUcsRUFBQyxNQUFNLEVBQUcsTUFBTSxFQUFDLEVBQUMsQ0FBQyxDQUFBO1FBQzVFLE9BQU8sQ0FBQyxJQUFJLEdBQUcsT0FBTyxDQUFDO0lBQzNCLENBQUM7SUFDRCxPQUFPLEtBQUssRUFDWixDQUFDO1FBQ0csT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDeEIsSUFBSSxLQUFLLFlBQVksS0FBSyxFQUN4QixDQUFDO1lBQ0MsT0FBTyxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUMsT0FBTyxDQUFDO1lBQ2hDLE9BQU8sR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7UUFDdEMsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPLEdBQUcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUE7QUFDNUIsQ0FBQztBQUdNLEtBQUssVUFBVSx1QkFBdUIsQ0FBQyxHQUFrQixFQUFHLEdBQWdCO0lBR2pGLE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxNQUFhLENBQUM7SUFDakMsTUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNyQyxNQUFNLE9BQU8sR0FBZ0MsRUFBQyxPQUFPLEVBQUcsSUFBSSxFQUFJLE9BQU8sRUFBRyxnQkFBZ0IsRUFBQyxDQUFBO0lBRTNGLElBQ0EsQ0FBQztRQUVELE1BQU0sV0FBVyxHQUFHLE1BQU0sa0JBQU0sQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDO1lBQ25ELEtBQUssRUFDTDtnQkFDRSxNQUFNLEVBQUUsVUFBVTtnQkFDbEIsRUFBRSxFQUFFO29CQUNGLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBQztvQkFDakIsRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFO2lCQUNuQjthQUNKO1NBQ0EsQ0FBQyxDQUFDO1FBRUgsTUFBTSxTQUFTLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUssRUFBRSxFQUFFLEdBQUUsT0FBTyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyRyxNQUFNLFFBQVEsR0FBRyxNQUFNLGtCQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEtBQUssRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxTQUFTLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNwRixPQUFPLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQztJQUUxQixDQUFDO0lBQ0QsT0FBTyxLQUFLLEVBQ1YsQ0FBQztRQUNDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3hCLElBQUksS0FBSyxZQUFZLEtBQUssRUFDeEIsQ0FBQztZQUNDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztZQUNoQyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3RDLENBQUM7SUFDTCxDQUFDO0lBRUgsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0FBQzFCLENBQUM7QUFLTSxLQUFLLFVBQVUsa0JBQWtCLENBQUMsR0FBa0IsRUFBRyxHQUFnQjtJQUUxRSxNQUFNLE9BQU8sR0FBcUMsRUFBQyxPQUFPLEVBQUcsSUFBSSxFQUFJLE9BQU8sRUFBRyxzQkFBc0IsRUFBQyxDQUFBO0lBQ3RHLE1BQU0sRUFBRSxFQUFFLEVBQUUsR0FBRyxHQUFHLENBQUMsTUFBYSxDQUFDO0lBRWpDLElBQ0EsQ0FBQztRQUNHLE1BQU0sT0FBTyxHQUFHLE1BQU0sa0JBQU0sQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLEVBQUMsS0FBSyxFQUFHLEVBQUMsTUFBTSxFQUFHLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBQyxFQUFDLENBQUMsQ0FBQTtRQUNoRixPQUFPLENBQUMsSUFBSSxHQUFHLE9BQU8sQ0FBQztJQUMzQixDQUFDO0lBQ0QsT0FBTyxLQUFLLEVBQ1osQ0FBQztRQUNHLE9BQU8sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3hCLElBQUksS0FBSyxZQUFZLEtBQUssRUFDeEIsQ0FBQztZQUNDLE9BQU8sQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQztZQUNoQyxPQUFPLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBQ3RDLENBQUM7SUFDUCxDQUFDO0lBRUQsT0FBTyxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO0FBQzVCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBGYXN0aWZ5UmVxdWVzdCwgRmFzdGlmeVJlcGx5IH0gZnJvbSAnZmFzdGlmeSc7XG5pbXBvcnQgcHJpc21hIGZyb20gJy4uL2RiL2RhdGFiYXNlJztcbmltcG9ydCB7IGNvbnZlcnRNdWx0aXBhcnRUb0pzb24gfSBmcm9tICcuLi91dGlscy91dGlscyc7XG5pbXBvcnQgeyBBcGlSZXNwb25zZSB9IGZyb20gJy4uL3V0aWxzL2Vycm9ySGFuZGxlcic7XG5pbXBvcnQgeyBVc2VyUHJvZmlsZSB9IGZyb20gJy4uL3V0aWxzL3R5cGVzJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVByb2ZpbGVIYW5kbGVyKHJlcTpGYXN0aWZ5UmVxdWVzdCAsIHJlczpGYXN0aWZ5UmVwbHkpXG57XG4gICAgY29uc3QgcmVzcG9uZCA6IEFwaVJlc3BvbnNlPG51bGwgPiA9IHtzdWNjZXNzIDogdHJ1ZSAgLCBtZXNzYWdlIDogJ3VzZXIgY3JlYXRlZCBzdWNjZXNzJ31cbiAgICBjb25zdCBib2R5ID0gcmVxLmJvZHkgYXMgYW55O1xuICAgIGNvbnN0IHByb2ZpbGUgPSB7dXNlcklkIDogYm9keS5pZCAsIGZuYW1lIDogYm9keS5mbmFtZSAsIGxuYW1lIDogYm9keS5sbmFtZSAgLCB1c2VybmFtZSA6IGJvZHkudXNlcm5hbWUgICwgYmlvIDogYm9keT8uYmlvID8/ICdSZWFkeSB0byBwbGF5LiBSZWFkeSB0byB3aW4uJyAgLCBhdmF0YXI6IGJvZHkuYXZhdGFyIH1cbiAgICBcbiAgICB0cnkgXG4gICAge1xuICAgICAgY29uc29sZS5sb2coXCJpcyBjcmVhdGVkIHNzc3MxMTFcIilcbiAgICAgIGF3YWl0IHByaXNtYS5wcm9maWxlLmNyZWF0ZSh7ZGF0YSA6IHByb2ZpbGV9KVxuICAgICAgY29uc29sZS5sb2coXCJpcyBjcmVhdGVkIHNzc3MyMjJcIilcbiAgICB9IFxuICAgIGNhdGNoIChlcnJvcikgXG4gICAge1xuICAgICAgcmVzcG9uZC5zdWNjZXNzID0gZmFsc2U7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcilcbiAgICAgICAge1xuICAgICAgICAgIHJlc3BvbmQubWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKHJlc3BvbmQpXG4gICAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlcy5zZW5kKHJlc3BvbmQpXG59XG5cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlUHJvZmlsZUhhbmRsZXIocmVxOkZhc3RpZnlSZXF1ZXN0ICwgcmVzOkZhc3RpZnlSZXBseSlcbntcbiAgXG4gICAgY29uc3QgcmVzcG9uZCA6IEFwaVJlc3BvbnNlPG51bGwgPiA9IHtzdWNjZXNzIDogdHJ1ZSAgLCBtZXNzYWdlIDogJ3VzZXIgdXBkYXRlZCBzdWNjZXNzJ31cblxuICAgIHRyeSBcbiAgICB7XG5cbiAgICBjb25zdCBib2R5ID0gYXdhaXQgY29udmVydE11bHRpcGFydFRvSnNvbihyZXEpO1xuICAgIGNvbnNvbGUubG9nKCdib2R5eXl5eXknICwgICBib2R5KVxuICAgIGNvbnN0IGhlYWRlcnMgPSByZXEuaGVhZGVycyBhcyBhbnk7XG4gICAgY29uc3QgdXNlcklkID0gTnVtYmVyKGhlYWRlcnNbJ3gtdXNlci1pZCddKVxuXG4gICAgYXdhaXQgcHJpc21hLnByb2ZpbGUudXBkYXRlKHt3aGVyZSA6IHt1c2VySWR9ICwgZGF0YSA6IGJvZHkgfSlcbiAgICB9XG4gICAgY2F0Y2ggKGVycm9yKSBcbiAgICB7XG4gICAgICAgIHJlc3BvbmQuc3VjY2VzcyA9IGZhbHNlO1xuICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcilcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZXNwb25kLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKHJlc3BvbmQpXG4gICAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gcmVzLnNlbmQocmVzcG9uZClcbn1cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QWxsVXNlckhhbmRsZXIocmVxOkZhc3RpZnlSZXF1ZXN0ICwgcmVzOkZhc3RpZnlSZXBseSlcbntcbiAgICBjb25zdCByZXNwb25kIDogQXBpUmVzcG9uc2U8VXNlclByb2ZpbGVbXT4gPSB7c3VjY2VzcyA6IHRydWUgICwgbWVzc2FnZSA6ICd1c2VyIGNyZWF0ZWQgc3VjY2Vzcyd9XG5cbiAgICB0cnkgXG4gICAge1xuICAgICAgICBjb25zdCBoZWFkZXJzID0gcmVxLmhlYWRlcnMgYXMgYW55O1xuICAgICAgICBjb25zdCB1c2VySWQgPSBOdW1iZXIoaGVhZGVyc1sneC11c2VyLWlkJ10pXG4gICAgXG4gICAgXG4gICAgICAgIGNvbnN0IGZyaWVuZHNoaXBzID0gYXdhaXQgcHJpc21hLmZyaWVuZHNoaXAuZmluZE1hbnkoKTtcbiAgICAgICAgY29uc3QgZnJpZW5kSWRzID0gIFsuLi5uZXcgU2V0KGZyaWVuZHNoaXBzLmZsYXRNYXAoKGY6YW55KSA9PiB7cmV0dXJuIFtmLnVzZXJJZCwgZi5mcmllbmRJZF19KSldIGFzIGFueTtcbiAgICAgICAgaWYgKCFmcmllbmRJZHMuaW5jbHVkZXModXNlcklkKSlcbiAgICAgICAgICAgIGZyaWVuZElkcy5wdXNoKHVzZXJJZCk7XG4gICAgXG4gICAgICAgIGNvbnN0IHByb2ZpbGUgPSBhd2FpdCBwcmlzbWEucHJvZmlsZS5maW5kTWFueSh7d2hlcmUgOiB7dXNlcklkIDoge25vdEluOiBmcmllbmRJZHN9fX0pO1xuICAgICAgICByZXNwb25kLmRhdGEgPSBwcm9maWxlO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIFxuICAgIHtcbiAgICAgICAgcmVzcG9uZC5zdWNjZXNzID0gZmFsc2U7XG4gICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJlc3BvbmQubWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7XG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgICAgICB9XG4gICAgfVxuICAgICAgICBcbiAgICByZXR1cm4gcmVzLnNlbmQocmVzcG9uZClcbn1cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlUHJvZmlsZUhhbmRsZXIocmVxOkZhc3RpZnlSZXF1ZXN0ICwgcmVzOkZhc3RpZnlSZXBseSlcbntcbiAgICBjb25zdCByZXNwb25kIDogQXBpUmVzcG9uc2U8bnVsbD4gPSB7c3VjY2VzcyA6IHRydWUgICwgbWVzc2FnZSA6ICd1c2VyIGNyZWF0ZWQgc3VjY2Vzcyd9XG5cbiAgICB0cnkgXG4gICAge1xuICAgIC8vIGNvbnN0IGhlYWRlcnMgPSByZXEuaGVhZGVycyBhcyBhbnk7XG4gICAgLy8gY29uc3QgdXNlcklkID0gTnVtYmVyKGhlYWRlcnNbJ3gtdXNlci1pZCddKVxuICAgICAgICBcbiAgICB9IFxuICAgIGNhdGNoIChlcnJvcikgXG4gICAge1xuICAgICAgICByZXNwb25kLnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICAgICAgaWYgKGVycm9yIGluc3RhbmNlb2YgRXJyb3IpXG4gICAgICAgICAge1xuICAgICAgICAgICAgcmVzcG9uZC5tZXNzYWdlID0gZXJyb3IubWVzc2FnZTtcbiAgICAgICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZChyZXNwb25kKVxuICAgICAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gcmVzLnNlbmQocmVzcG9uZClcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEN1cnJlbnRVc2VySGFuZGxlcihyZXE6RmFzdGlmeVJlcXVlc3QgLCByZXM6RmFzdGlmeVJlcGx5KVxue1xuXG4gICAgY29uc3QgcmVzcG9uZCA6IEFwaVJlc3BvbnNlPFVzZXJQcm9maWxlIHwgbnVsbD4gPSB7c3VjY2VzcyA6IHRydWUgICwgbWVzc2FnZSA6ICd1c2VyIGNyZWF0ZWQgc3VjY2Vzcyd9XG5cbiAgICB0cnkgXG4gICAge1xuICAgICAgICBjb25zdCBoZWFkZXJzID0gcmVxLmhlYWRlcnMgYXMgYW55O1xuICAgICAgICBjb25zdCB1c2VySWQgPSBOdW1iZXIoaGVhZGVyc1sneC11c2VyLWlkJ10pIGFzIG51bWJlcjtcbiAgICAgICAgY29uc3QgcHJvZmlsZSA9IGF3YWl0IHByaXNtYS5wcm9maWxlLmZpbmRVbmlxdWUoe3doZXJlIDoge3VzZXJJZCA6IHVzZXJJZH19KVxuICAgICAgICByZXNwb25kLmRhdGEgPSBwcm9maWxlO1xuICAgIH0gXG4gICAgY2F0Y2ggKGVycm9yKSBcbiAgICB7XG4gICAgICAgIHJlc3BvbmQuc3VjY2VzcyA9IGZhbHNlO1xuICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcilcbiAgICAgICAgICB7XG4gICAgICAgICAgICByZXNwb25kLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKHJlc3BvbmQpXG4gICAgICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXMuc2VuZChyZXNwb25kKVxufVxuXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGcmllbmRzT2ZVc2VySGFuZGxlcihyZXE6RmFzdGlmeVJlcXVlc3QgLCByZXM6RmFzdGlmeVJlcGx5KVxue1xuXG4gIGNvbnN0IHBhcmFtcyA9IHJlcS5wYXJhbXMgYXMgYW55O1xuICBjb25zdCB1c2VySWQgPSBOdW1iZXIocGFyYW1zLnVzZXJJZCk7XG4gIGNvbnN0IHJlc3BvbmQgOiBBcGlSZXNwb25zZTxVc2VyUHJvZmlsZVtdPiA9IHtzdWNjZXNzIDogdHJ1ZSAgLCBtZXNzYWdlIDogJ2dldCBhbGwgdXNlcnMgJ31cblxuICB0cnkgXG4gIHtcblxuICBjb25zdCBmcmllbmRzaGlwcyA9IGF3YWl0IHByaXNtYS5mcmllbmRzaGlwLmZpbmRNYW55KHtcbiAgICB3aGVyZTogXG4gICAge1xuICAgICAgc3RhdHVzOiAnYWNjZXB0ZWQnLFxuICAgICAgT1I6IFtcbiAgICAgICAgeyB1c2VySWQ6IHVzZXJJZH0sXG4gICAgICAgIHsgZnJpZW5kSWQ6IHVzZXJJZCB9XG4gICAgICAgIF1cbiAgICB9XG4gICAgfSk7XG4gICAgXG4gICAgY29uc3QgZnJpZW5kSWRzID0gZnJpZW5kc2hpcHMubWFwKChmOmFueSkgPT4ge3JldHVybiAodXNlcklkICE9IGYudXNlcklkKSA/IGYudXNlcklkIDogZi5mcmllbmRJZCB9KTtcbiAgICBjb25zdCBwcm9maWxlcyA9IGF3YWl0IHByaXNtYS5wcm9maWxlLmZpbmRNYW55KHsgd2hlcmU6IHsgaWQ6IHsgaW46IGZyaWVuZElkcyB9IH0gfSlcbiAgICByZXNwb25kLmRhdGEgPSBwcm9maWxlcztcbiAgXG4gIH1cbiAgY2F0Y2ggKGVycm9yKSBcbiAgICB7XG4gICAgICByZXNwb25kLnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAgICB7XG4gICAgICAgICAgcmVzcG9uZC5tZXNzYWdlID0gZXJyb3IubWVzc2FnZTtcbiAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgICAgfVxuICAgIH1cbiAgXG4gIHJldHVybiByZXMuc2VuZChyZXNwb25kKVxufVxuXG5cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0VXNlckJ5SWRIYW5kbGVyKHJlcTpGYXN0aWZ5UmVxdWVzdCAsIHJlczpGYXN0aWZ5UmVwbHkpXG57XG4gICAgY29uc3QgcmVzcG9uZCA6IEFwaVJlc3BvbnNlPFVzZXJQcm9maWxlIHwgbnVsbD4gPSB7c3VjY2VzcyA6IHRydWUgICwgbWVzc2FnZSA6ICd1c2VyIGNyZWF0ZWQgc3VjY2Vzcyd9XG4gICAgY29uc3QgeyBpZCB9ID0gcmVxLnBhcmFtcyBhcyBhbnk7XG5cbiAgICB0cnkgXG4gICAge1xuICAgICAgICBjb25zdCBwcm9maWxlID0gYXdhaXQgcHJpc21hLnByb2ZpbGUuZmluZFVuaXF1ZSh7d2hlcmUgOiB7dXNlcklkIDogTnVtYmVyKGlkKX19KVxuICAgICAgICByZXNwb25kLmRhdGEgPSBwcm9maWxlO1xuICAgIH1cbiAgICBjYXRjaCAoZXJyb3IpIFxuICAgIHtcbiAgICAgICAgcmVzcG9uZC5zdWNjZXNzID0gZmFsc2U7XG4gICAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAgICAgIHtcbiAgICAgICAgICAgIHJlc3BvbmQubWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7XG4gICAgICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcy5zZW5kKHJlc3BvbmQpXG59XG4iXX0=