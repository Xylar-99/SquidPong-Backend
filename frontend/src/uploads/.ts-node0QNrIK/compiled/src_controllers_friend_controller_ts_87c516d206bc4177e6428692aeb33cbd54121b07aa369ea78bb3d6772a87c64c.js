"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.sendFriendInvite = sendFriendInvite;
exports.getFriendsListHandler = getFriendsListHandler;
exports.getPendingRequestsHandler = getPendingRequestsHandler;
exports.sendFriendRequestHandler = sendFriendRequestHandler;
exports.acceptFriendRequestHandler = acceptFriendRequestHandler;
exports.rejectFriendRequestHandler = rejectFriendRequestHandler;
exports.removeFriendHandler = removeFriendHandler;
exports.cancelFriendRequestHandler = cancelFriendRequestHandler;
exports.getSentRequestsHandler = getSentRequestsHandler;
exports.getReceivedRequestsHandler = getReceivedRequestsHandler;
const database_1 = __importDefault(require("../db/database"));
const utils_1 = require("../utils/utils");
async function sendFriendInvite(data) {
    delete data.type;
    try {
        if (!await (0, utils_1.isFriendRequestExists)(data))
            await database_1.default.friendship.create({ data: data });
    }
    catch (error) {
        console.log("error in invite friend");
    }
}
async function getFriendsListHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    const headers = req.headers;
    const userId = Number(headers['x-user-id']);
    try {
        const friendships = await database_1.default.friendship.findMany({
            where: {
                status: 'accepted',
                OR: [
                    { userId: userId },
                    { friendId: userId }
                ]
            }
        });
        const friendIds = friendships.map((f) => { return (userId != f.userId) ? f.userId : f.friendId; });
        const profiles = await database_1.default.profile.findMany({ where: { id: { in: friendIds } } });
        respond.data = profiles;
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function getPendingRequestsHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    const headers = req.headers;
    const userId = Number(headers['x-user-id']);
    try {
        const friendships = await database_1.default.friendship.findMany({
            where: { friendId: userId, status: 'pending' }
        });
        const friendIds = friendships.map((arg) => { return arg.userId; });
        const profiles = await database_1.default.profile.findMany({
            where: {
                id: { in: friendIds }
            }
        });
        respond.data = profiles;
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function sendFriendRequestHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    const body = req.body;
    const headers = req.headers;
    const userId = Number(headers['x-user-id']);
    const friendata = {};
    friendata['userId'] = userId;
    friendata['friendId'] = body.friendId;
    friendata['status'] = 'pending';
    try {
        if (await (0, utils_1.isFriendRequestExists)(friendata))
            throw new Error("ready exist friends");
        await database_1.default.friendship.create({ data: friendata });
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function acceptFriendRequestHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    const body = req.body;
    const headers = req.headers;
    const userId = Number(headers['x-user-id']);
    const friendata = {};
    friendata['userId'] = userId;
    friendata['friendId'] = body.friendId;
    friendata['status'] = 'accepted';
    try {
        if (await (0, utils_1.isFriendRequestExists)(friendata))
            throw new Error("ready exist friends");
        await database_1.default.friendship.updateMany({
            where: {
                OR: [
                    { userId: friendata.userId, friendId: friendata.friendId },
                    { userId: friendata.friendId, friendId: friendata.userId }
                ]
            },
            data: { status: 'accepted' }
        });
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function rejectFriendRequestHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    const body = req.body;
    const headers = req.headers;
    const userId = Number(headers['x-user-id']);
    const friendata = {};
    friendata['userId'] = userId;
    friendata['friendId'] = body.friendId;
    friendata['status'] = 'pending';
    try {
        if (!await (0, utils_1.isFriendRequestExists)(friendata))
            throw new Error("ready reject friends");
        await database_1.default.friendship.deleteMany({
            where: {
                OR: [
                    { userId: friendata.userId, friendId: friendata.friendId },
                    { userId: friendata.friendId, friendId: friendata.userId }
                ]
            }
        });
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function removeFriendHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    const { friendId } = req.params;
    const headers = req.headers;
    const userId = Number(headers['x-user-id']);
    const friendata = {};
    friendata['userId'] = userId;
    friendata['friendId'] = friendId;
    friendata['status'] = 'accepted';
    try {
        if (!await (0, utils_1.isFriendRequestExists)(friendata))
            throw new Error("ready is not friends");
        await database_1.default.friendship.deleteMany({
            where: {
                OR: [
                    { userId: friendata.userId, friendId: friendata.friendId },
                    { userId: friendata.friendId, friendId: friendata.userId }
                ]
            }
        });
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function cancelFriendRequestHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    try {
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function getSentRequestsHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    try {
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
async function getReceivedRequestsHandler(req, res) {
    const respond = { success: true, message: 'user created success' };
    try {
    }
    catch (error) {
        respond.success = false;
        if (error instanceof Error) {
            respond.message = error.message;
            return res.status(400).send(respond);
        }
    }
    return res.send(respond);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiL3VzZXIvc3JjL2NvbnRyb2xsZXJzL2ZyaWVuZC5jb250cm9sbGVyLnRzIiwic291cmNlcyI6WyIvdXNlci9zcmMvY29udHJvbGxlcnMvZnJpZW5kLmNvbnRyb2xsZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFNQSw0Q0FjQztBQUdELHNEQW9DQztBQUdELDhEQWlDQztBQUlELDREQWdDQztBQUdELGdFQXlDQztBQUdELGdFQXNDQztBQUlELGtEQXdDQztBQUdELGdFQXNCQztBQUVELHdEQXNCQztBQUdELGdFQXNCQztBQTdVRCw4REFBb0M7QUFDcEMsMENBQXVEO0FBSWhELEtBQUssVUFBVSxnQkFBZ0IsQ0FBQyxJQUFRO0lBRTNDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQztJQUVqQixJQUNBLENBQUM7UUFDQyxJQUFHLENBQUMsTUFBTSxJQUFBLDZCQUFxQixFQUFDLElBQUksQ0FBQztZQUNuQyxNQUFNLGtCQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFDLElBQUksRUFBRyxJQUFJLEVBQUMsQ0FBQyxDQUFBO0lBQ2pELENBQUM7SUFDRCxPQUFPLEtBQUssRUFDWixDQUFDO1FBQ0MsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3QkFBd0IsQ0FBQyxDQUFBO0lBQ3ZDLENBQUM7QUFFTCxDQUFDO0FBR00sS0FBSyxVQUFVLHFCQUFxQixDQUFDLEdBQWtCLEVBQUcsR0FBZ0I7SUFFL0UsTUFBTSxPQUFPLEdBQWdDLEVBQUMsT0FBTyxFQUFHLElBQUksRUFBSSxPQUFPLEVBQUcsc0JBQXNCLEVBQUMsQ0FBQTtJQUNqRyxNQUFNLE9BQU8sR0FBRyxHQUFHLENBQUMsT0FBYyxDQUFDO0lBQ25DLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQTtJQUUzQyxJQUNBLENBQUM7UUFFRCxNQUFNLFdBQVcsR0FBRyxNQUFNLGtCQUFNLENBQUMsVUFBVSxDQUFDLFFBQVEsQ0FBQztZQUNuRCxLQUFL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QUMxQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmFzdGlmeVJlcXVlc3QsIEZhc3RpZnlSZXBseSB9IGZyb20gJ2Zhc3RpZnknO1xuaW1wb3J0IHByaXNtYSBmcm9tICcuLi9kYi9kYXRhYmFzZSc7XG5pbXBvcnQgeyBpc0ZyaWVuZFJlcXVlc3RFeGlzdHMgfSBmcm9tICcuLi91dGlscy91dGlscyc7XG5pbXBvcnQgeyBBcGlSZXNwb25zZSB9IGZyb20gJy4uL3V0aWxzL2Vycm9ySGFuZGxlcic7XG5pbXBvcnQgeyBVc2VyUHJvZmlsZSB9IGZyb20gJy4uL3V0aWxzL3R5cGVzJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRGcmllbmRJbnZpdGUoZGF0YTphbnkpIFxue1xuICAgIGRlbGV0ZSBkYXRhLnR5cGU7XG4gICAgXG4gICAgdHJ5IFxuICAgIHtcbiAgICAgIGlmKCFhd2FpdCBpc0ZyaWVuZFJlcXVlc3RFeGlzdHMoZGF0YSkpXG4gICAgICAgIGF3YWl0IHByaXNtYS5mcmllbmRzaGlwLmNyZWF0ZSh7ZGF0YSA6IGRhdGF9KVxuICAgIH0gXG4gICAgY2F0Y2ggKGVycm9yKSBcbiAgICB7XG4gICAgICBjb25zb2xlLmxvZyhcImVycm9yIGluIGludml0ZSBmcmllbmRcIikgIFxuICAgIH1cblxufVxuXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRGcmllbmRzTGlzdEhhbmRsZXIocmVxOkZhc3RpZnlSZXF1ZXN0ICwgcmVzOkZhc3RpZnlSZXBseSlcbntcbiAgY29uc3QgcmVzcG9uZCA6IEFwaVJlc3BvbnNlPFVzZXJQcm9maWxlW10+ID0ge3N1Y2Nlc3MgOiB0cnVlICAsIG1lc3NhZ2UgOiAndXNlciBjcmVhdGVkIHN1Y2Nlc3MnfVxuICBjb25zdCBoZWFkZXJzID0gcmVxLmhlYWRlcnMgYXMgYW55O1xuICBjb25zdCB1c2VySWQgPSBOdW1iZXIoaGVhZGVyc1sneC11c2VyLWlkJ10pXG5cbiAgdHJ5IFxuICB7XG5cbiAgY29uc3QgZnJpZW5kc2hpcHMgPSBhd2FpdCBwcmlzbWEuZnJpZW5kc2hpcC5maW5kTWFueSh7XG4gICAgd2hlcmU6IFxuICAgIHtcbiAgICAgIHN0YXR1czogJ2FjY2VwdGVkJyxcbiAgICAgIE9SOiBbXG4gICAgICAgIHsgdXNlcklkOiB1c2VySWR9LFxuICAgICAgICB7IGZyaWVuZElkOiB1c2VySWQgfVxuICAgICAgICBdXG4gICAgfVxuICAgIH0pO1xuICAgIFxuICAgIGNvbnN0IGZyaWVuZElkcyA9IGZyaWVuZHNoaXBzLm1hcCgoZjphbnkpID0+IHtyZXR1cm4gKHVzZXJJZCAhPSBmLnVzZXJJZCkgPyBmLnVzZXJJZCA6IGYuZnJpZW5kSWQgfSk7XG4gICAgY29uc3QgcHJvZmlsZXMgPSBhd2FpdCBwcmlzbWEucHJvZmlsZS5maW5kTWFueSh7IHdoZXJlOiB7IGlkOiB7IGluOiBmcmllbmRJZHMgfSB9IH0pXG4gICAgcmVzcG9uZC5kYXRhID0gcHJvZmlsZXM7XG4gIFxuICB9XG4gIGNhdGNoIChlcnJvcikgXG4gICAge1xuICAgICAgcmVzcG9uZC5zdWNjZXNzID0gZmFsc2U7XG4gICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcilcbiAgICAgICAge1xuICAgICAgICAgIHJlc3BvbmQubWVzc2FnZSA9IGVycm9yLm1lc3NhZ2U7XG4gICAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKHJlc3BvbmQpXG4gICAgICAgIH1cbiAgICB9XG4gIFxuICByZXR1cm4gcmVzLnNlbmQocmVzcG9uZClcbn1cblxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UGVuZGluZ1JlcXVlc3RzSGFuZGxlcihyZXE6RmFzdGlmeVJlcXVlc3QgLCByZXM6RmFzdGlmeVJlcGx5KVxue1xuICBjb25zdCByZXNwb25kIDogQXBpUmVzcG9uc2U8VXNlclByb2ZpbGVbXT4gPSB7c3VjY2VzcyA6IHRydWUgICwgbWVzc2FnZSA6ICd1c2VyIGNyZWF0ZWQgc3VjY2Vzcyd9XG5cbiAgY29uc3QgaGVhZGVycyA9IHJlcS5oZWFkZXJzIGFzIGFueTtcbiAgY29uc3QgdXNlcklkID0gTnVtYmVyKGhlYWRlcnNbJ3gtdXNlci1pZCddKVxuICBcbiAgdHJ5IFxuICB7XG4gICAgY29uc3QgZnJpZW5kc2hpcHMgPSBhd2FpdCBwcmlzbWEuZnJpZW5kc2hpcC5maW5kTWFueSh7XG4gICAgICB3aGVyZToge2ZyaWVuZElkIDogdXNlcklkICwgc3RhdHVzOiAncGVuZGluZyd9XG4gICAgfSk7XG4gICAgXG4gICAgY29uc3QgZnJpZW5kSWRzOmFueSA9IGZyaWVuZHNoaXBzLm1hcCgoYXJnOmFueSkgPT4ge3JldHVybiBhcmcudXNlcklkfSk7XG4gIFxuICAgIGNvbnN0IHByb2ZpbGVzID0gYXdhaXQgcHJpc21hLnByb2ZpbGUuZmluZE1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgaWQ6IHsgaW46IGZyaWVuZElkcyB9XG4gICAgICB9XG4gICAgfSlcbiAgICByZXNwb25kLmRhdGEgID0gcHJvZmlsZXNcbiAgfSBcbiAgY2F0Y2ggKGVycm9yKSBcbiAge1xuICAgIHJlc3BvbmQuc3VjY2VzcyA9IGZhbHNlO1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAge1xuICAgICAgICByZXNwb25kLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgIH1cbiAgfVxuICBcbiAgcmV0dXJuIHJlcy5zZW5kKHJlc3BvbmQpO1xufVxuXG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHNlbmRGcmllbmRSZXF1ZXN0SGFuZGxlcihyZXE6RmFzdGlmeVJlcXVlc3QgLCByZXM6RmFzdGlmeVJlcGx5KVxue1xuICBjb25zdCByZXNwb25kIDogQXBpUmVzcG9uc2U8bnVsbD4gPSB7c3VjY2VzcyA6IHRydWUgICwgbWVzc2FnZSA6ICd1c2VyIGNyZWF0ZWQgc3VjY2Vzcyd9XG5cbiAgY29uc3QgYm9keSA9IHJlcS5ib2R5IGFzIGFueTtcbiAgY29uc3QgaGVhZGVycyA9IHJlcS5oZWFkZXJzIGFzIGFueTtcbiAgY29uc3QgdXNlcklkID0gTnVtYmVyKGhlYWRlcnNbJ3gtdXNlci1pZCddKVxuXG4gIGNvbnN0IGZyaWVuZGF0YTphbnkgPSB7fTtcbiAgZnJpZW5kYXRhWyd1c2VySWQnXSA9IHVzZXJJZDtcbiAgZnJpZW5kYXRhWydmcmllbmRJZCddID0gYm9keS5mcmllbmRJZDtcbiAgZnJpZW5kYXRhWydzdGF0dXMnXSA9ICdwZW5kaW5nJztcblxuXG4gIHRyeSBcbiAge1xuICAgIGlmKGF3YWl0IGlzRnJpZW5kUmVxdWVzdEV4aXN0cyhmcmllbmRhdGEpKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKFwicmVhZHkgZXhpc3QgZnJpZW5kc1wiKVxuXG4gICAgYXdhaXQgcHJpc21hLmZyaWVuZHNoaXAuY3JlYXRlKHtkYXRhIDogZnJpZW5kYXRhfSlcbiAgfSBcbiAgY2F0Y2ggKGVycm9yKSBcbiAge1xuICAgIHJlc3BvbmQuc3VjY2VzcyA9IGZhbHNlO1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAge1xuICAgICAgICByZXNwb25kLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgIH1cbiAgfVxuICBcbiAgcmV0dXJuIHJlcy5zZW5kKHJlc3BvbmQpXG59XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGFjY2VwdEZyaWVuZFJlcXVlc3RIYW5kbGVyKHJlcTpGYXN0aWZ5UmVxdWVzdCAsIHJlczpGYXN0aWZ5UmVwbHkpXG57XG4gIGNvbnN0IHJlc3BvbmQgOiBBcGlSZXNwb25zZTxudWxsPiA9IHtzdWNjZXNzIDogdHJ1ZSAgLCBtZXNzYWdlIDogJ3VzZXIgY3JlYXRlZCBzdWNjZXNzJ31cbiAgXG4gIGNvbnN0IGJvZHkgPSByZXEuYm9keSBhcyBhbnk7XG4gIGNvbnN0IGhlYWRlcnMgPSByZXEuaGVhZGVycyBhcyBhbnk7XG4gIGNvbnN0IHVzZXJJZCA9IE51bWJlcihoZWFkZXJzWyd4LXVzZXItaWQnXSlcblxuICBjb25zdCBmcmllbmRhdGE6YW55ID0ge307XG4gIGZyaWVuZGF0YVsndXNlcklkJ10gPSB1c2VySWQ7XG4gIGZyaWVuZGF0YVsnZnJpZW5kSWQnXSA9IGJvZHkuZnJpZW5kSWQ7XG4gIGZyaWVuZGF0YVsnc3RhdHVzJ10gPSAnYWNjZXB0ZWQnO1xuICBcblxuICB0cnkgXG4gIHtcbiAgICBpZihhd2FpdCBpc0ZyaWVuZFJlcXVlc3RFeGlzdHMoZnJpZW5kYXRhKSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInJlYWR5IGV4aXN0IGZyaWVuZHNcIilcbiAgXG4gICAgYXdhaXQgcHJpc21hLmZyaWVuZHNoaXAudXBkYXRlTWFueSh7XG4gICAgICB3aGVyZToge1xuICAgICAgICBPUjogW1xuICAgICAgICAgIHsgdXNlcklkOiBmcmllbmRhdGEudXNlcklkLCBmcmllbmRJZDogZnJpZW5kYXRhLmZyaWVuZElkIH0sXG4gICAgICAgICAgeyB1c2VySWQ6IGZyaWVuZGF0YS5mcmllbmRJZCwgZnJpZW5kSWQ6IGZyaWVuZGF0YS51c2VySWQgfVxuICAgICAgICBdXG4gICAgICB9LFxuICAgICAgZGF0YTogeyBzdGF0dXM6ICdhY2NlcHRlZCcgfVxuICAgIH0pO1xuICAgIFxuICB9XG4gIGNhdGNoIChlcnJvcikgXG4gIHtcbiAgICByZXNwb25kLnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcilcbiAgICAgIHtcbiAgICAgICAgcmVzcG9uZC5tZXNzYWdlID0gZXJyb3IubWVzc2FnZTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKHJlc3BvbmQpXG4gICAgICB9XG4gIH1cbiAgXG4gIHJldHVybiByZXMuc2VuZChyZXNwb25kKVxufVxuXG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWplY3RGcmllbmRSZXF1ZXN0SGFuZGxlcihyZXE6RmFzdGlmeVJlcXVlc3QgLCByZXM6RmFzdGlmeVJlcGx5KVxue1xuICBjb25zdCByZXNwb25kIDogQXBpUmVzcG9uc2U8bnVsbD4gPSB7c3VjY2VzcyA6IHRydWUgICwgbWVzc2FnZSA6ICd1c2VyIGNyZWF0ZWQgc3VjY2Vzcyd9XG4gIGNvbnN0IGJvZHkgPSByZXEuYm9keSBhcyBhbnk7XG4gIGNvbnN0IGhlYWRlcnMgPSByZXEuaGVhZGVycyBhcyBhbnk7XG4gIGNvbnN0IHVzZXJJZCA9IE51bWJlcihoZWFkZXJzWyd4LXVzZXItaWQnXSlcblxuICBjb25zdCBmcmllbmRhdGE6YW55ID0ge307XG4gIGZyaWVuZGF0YVsndXNlcklkJ10gPSB1c2VySWQ7XG4gIGZyaWVuZGF0YVsnZnJpZW5kSWQnXSA9IGJvZHkuZnJpZW5kSWQ7XG4gIGZyaWVuZGF0YVsnc3RhdHVzJ10gPSAncGVuZGluZyc7XG4gIFxuXG4gIHRyeSBcbiAge1xuICAgIGlmKCFhd2FpdCBpc0ZyaWVuZFJlcXVlc3RFeGlzdHMoZnJpZW5kYXRhKSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihcInJlYWR5IHJlamVjdCBmcmllbmRzXCIpXG4gIFxuICAgIGF3YWl0IHByaXNtYS5mcmllbmRzaGlwLmRlbGV0ZU1hbnkoe1xuICAgICAgd2hlcmU6IHtcbiAgICAgICAgT1I6IFtcbiAgICAgICAgICB7IHVzZXJJZDogZnJpZW5kYXRhLnVzZXJJZCwgZnJpZW5kSWQ6IGZyaWVuZGF0YS5mcmllbmRJZCB9LFxuICAgICAgICAgIHsgdXNlcklkOiBmcmllbmRhdGEuZnJpZW5kSWQsIGZyaWVuZElkOiBmcmllbmRhdGEudXNlcklkIH1cbiAgICAgICAgXVxuICAgICAgfVxuICAgIH0pO1xuICB9XG4gIGNhdGNoIChlcnJvcikgXG4gIHtcbiAgICByZXNwb25kLnN1Y2Nlc3MgPSBmYWxzZTtcbiAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcilcbiAgICAgIHtcbiAgICAgICAgcmVzcG9uZC5tZXNzYWdlID0gZXJyb3IubWVzc2FnZTtcbiAgICAgICAgcmV0dXJuIHJlcy5zdGF0dXMoNDAwKS5zZW5kKHJlc3BvbmQpXG4gICAgICB9XG4gIH1cbiAgXG4gIHJldHVybiByZXMuc2VuZChyZXNwb25kKVxufVxuXG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZUZyaWVuZEhhbmRsZXIocmVxOkZhc3RpZnlSZXF1ZXN0ICwgcmVzOkZhc3RpZnlSZXBseSlcbntcbiAgY29uc3QgcmVzcG9uZCA6IEFwaVJlc3BvbnNlPG51bGw+ID0ge3N1Y2Nlc3MgOiB0cnVlICAsIG1lc3NhZ2UgOiAndXNlciBjcmVhdGVkIHN1Y2Nlc3MnfVxuXG4gIGNvbnN0IHtmcmllbmRJZH0gPSByZXEucGFyYW1zIGFzIGFueTtcbiAgY29uc3QgaGVhZGVycyA9IHJlcS5oZWFkZXJzIGFzIGFueTtcbiAgY29uc3QgdXNlcklkID0gTnVtYmVyKGhlYWRlcnNbJ3gtdXNlci1pZCddKVxuXG4gIGNvbnN0IGZyaWVuZGF0YTphbnkgPSB7fTtcbiAgZnJpZW5kYXRhWyd1c2VySWQnXSA9IHVzZXJJZDtcbiAgZnJpZW5kYXRhWydmcmllbmRJZCddID0gZnJpZW5kSWQ7XG4gIGZyaWVuZGF0YVsnc3RhdHVzJ10gPSAnYWNjZXB0ZWQnO1xuICBcblxuICB0cnkgXG4gIHtcbiAgICBpZighYXdhaXQgaXNGcmllbmRSZXF1ZXN0RXhpc3RzKGZyaWVuZGF0YSkpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJyZWFkeSBpcyBub3QgZnJpZW5kc1wiKVxuICBcbiAgICBhd2FpdCBwcmlzbWEuZnJpZW5kc2hpcC5kZWxldGVNYW55KHtcbiAgICAgIHdoZXJlOiB7XG4gICAgICAgIE9SOiBbXG4gICAgICAgICAgeyB1c2VySWQ6IGZyaWVuZGF0YS51c2VySWQsIGZyaWVuZElkOiBmcmllbmRhdGEuZnJpZW5kSWQgfSxcbiAgICAgICAgICB7IHVzZXJJZDogZnJpZW5kYXRhLmZyaWVuZElkLCBmcmllbmRJZDogZnJpZW5kYXRhLnVzZXJJZCB9XG4gICAgICAgIF1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBcbiAgfSBcbiAgY2F0Y2ggKGVycm9yKSBcbiAge1xuICAgIHJlc3BvbmQuc3VjY2VzcyA9IGZhbHNlO1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAge1xuICAgICAgICByZXNwb25kLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgIH1cbiAgfVxuICBcbiAgcmV0dXJuIHJlcy5zZW5kKHJlc3BvbmQpXG59XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGNhbmNlbEZyaWVuZFJlcXVlc3RIYW5kbGVyKHJlcTpGYXN0aWZ5UmVxdWVzdCAsIHJlczpGYXN0aWZ5UmVwbHkpXG57XG4gIGNvbnN0IHJlc3BvbmQgOiBBcGlSZXNwb25zZTxudWxsPiA9IHtzdWNjZXNzIDogdHJ1ZSAgLCBtZXNzYWdlIDogJ3VzZXIgY3JlYXRlZCBzdWNjZXNzJ31cblxuICBcblxuICB0cnkgXG4gIHtcbiAgICBcbiAgICBcbiAgfSBcbiAgY2F0Y2ggKGVycm9yKSBcbiAge1xuICAgIHJlc3BvbmQuc3VjY2VzcyA9IGZhbHNlO1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAge1xuICAgICAgICByZXNwb25kLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgIH1cbiAgfVxuICBcbiAgcmV0dXJuIHJlcy5zZW5kKHJlc3BvbmQpXG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRTZW50UmVxdWVzdHNIYW5kbGVyKHJlcTpGYXN0aWZ5UmVxdWVzdCAsIHJlczpGYXN0aWZ5UmVwbHkpXG57XG4gIGNvbnN0IHJlc3BvbmQgOiBBcGlSZXNwb25zZTxudWxsPiA9IHtzdWNjZXNzIDogdHJ1ZSAgLCBtZXNzYWdlIDogJ3VzZXIgY3JlYXRlZCBzdWNjZXNzJ31cblxuICBcblxuICB0cnkgXG4gIHtcbiAgICBcbiAgICBcbiAgfSBcbiAgY2F0Y2ggKGVycm9yKSBcbiAge1xuICAgIHJlc3BvbmQuc3VjY2VzcyA9IGZhbHNlO1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAge1xuICAgICAgICByZXNwb25kLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgIH1cbiAgfVxuICBcbiAgcmV0dXJuIHJlcy5zZW5kKHJlc3BvbmQpXG59XG5cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFJlY2VpdmVkUmVxdWVzdHNIYW5kbGVyKHJlcTpGYXN0aWZ5UmVxdWVzdCAsIHJlczpGYXN0aWZ5UmVwbHkpXG57XG4gIGNvbnN0IHJlc3BvbmQgOiBBcGlSZXNwb25zZTxudWxsPiA9IHtzdWNjZXNzIDogdHJ1ZSAgLCBtZXNzYWdlIDogJ3VzZXIgY3JlYXRlZCBzdWNjZXNzJ31cblxuICBcblxuICB0cnkgXG4gIHtcbiAgICBcbiAgICBcbiAgfSBcbiAgY2F0Y2ggKGVycm9yKSBcbiAge1xuICAgIHJlc3BvbmQuc3VjY2VzcyA9IGZhbHNlO1xuICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yKVxuICAgICAge1xuICAgICAgICByZXNwb25kLm1lc3NhZ2UgPSBlcnJvci5tZXNzYWdlO1xuICAgICAgICByZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQocmVzcG9uZClcbiAgICAgIH1cbiAgfVxuICBcbiAgcmV0dXJuIHJlcy5zZW5kKHJlc3BvbmQpXG59XG4iXX0=